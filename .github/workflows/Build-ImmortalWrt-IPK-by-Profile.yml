# å·¥ä½œæµåç§°
name: Build-ImmortalWrt-IPK-from-Source

on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      profile:
        type: choice
        description: 'è¯·é€‰æ‹©æ‚¨çš„è®¾å¤‡å‹å· (ç”¨äºé…ç½®ç¼–è¯‘ç¯å¢ƒ)'
        options:
          - ariaboard_photonicat
          - armsom_sige3
          - armsom_sige7
          - cyber_cyber3588-aib
          - ezpro_mrkaio-m6s
          - firefly_roc-rk3328-cc
          - firefly_roc-rk3568-pc
          - friendlyarm_nanopc-t4
          - friendlyarm_nanopc-t6
          - friendlyarm_nanopi-r2c
          - friendlyarm_nanopi-r2c-plus
          - friendlyarm_nanopi-r2s
          - friendlyarm_nanopi-r3s
          - friendlyarm_nanopi-r4s
          - friendlyarm_nanopi-r4se
          - friendlyarm_nanopi-r4s-enterprise
          - friendlyarm_nanopi-r5c
          - friendlyarm_nanopi-r5s
          - friendlyarm_nanopi-r6c
          - friendlyarm_nanopi-r6s
          - huake_guangmiao-g4c
          - lunzn_fastrhino-r66s
          - lunzn_fastrhino-r68s
          - lyt_t68m
          - pine64_rock64
          - pine64_rockpro64
          - radxa_cm3_io
          - radxa_e25
          - radxa_rock-3a
          - radxa_rock-3b
          - radxa_rock-3c
          - radxa_rock-5a
          - radxa_rock-5b
          - radxa_rock-pi-4a
          - radxa_rock-pi-e
          - radxa_rock-pi-s
          - radxa_zero-3e
          - radxa_zero-3w
          - sinovoip_bpi-r2-pro
          - xunlong_orangepi-5
          - xunlong_orangepi-5-plus
          - xunlong_orangepi-r1-plus
          - xunlong_orangepi-r1-plus-lts
        required: true
        default: 'friendlyarm_nanopi-r4s'
      package_repo:
        description: 'è¦ç¼–è¯‘çš„æ’ä»¶ Git ä»“åº“åœ°å€'
        required: true
        default: 'https://github.com/sirpdboy/luci-app-ddns-go'
      package_name:
        description: 'æ’ä»¶åŒ…å (é€šå¸¸æ˜¯ä»“åº“å)'
        required: true
        default: 'luci-app-ddns-go'
      immortalwrt_branch_or_tag:
        description: 'è¦ç¼–è¯‘çš„ ImmortalWrt Git åˆ†æ”¯æˆ–æ ‡ç­¾'
        required: true
        default: 'v24.10.2'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget python3-pip
          sudo pip3 install pyelftools

      - name: Cache build environment
        uses: actions/cache@v4
        with:
          path: |
            ~/immortalwrt/staging_dir
            ~/immortalwrt/toolchain
            ~/immortalwrt/tmp
            ~/immortalwrt/dl
          key: ${{ runner.os }}-immortalwrt-${{ inputs.immortalwrt_branch_or_tag }}-${{ inputs.profile }}

      - name: Clone ImmortalWrt source code
        run: |
          # åˆ é™¤å¯èƒ½å­˜åœ¨çš„ç›®å½•
          if [ -d "~/immortalwrt" ]; then
            echo "åˆ é™¤å·²å­˜åœ¨çš„ immortalwrt ç›®å½•"
            rm -rf ~/immortalwrt
          fi
          
          echo "å…‹éš† ImmortalWrt æºç ..."
          git clone https://github.com/immortalwrt/immortalwrt.git -b ${{ inputs.immortalwrt_branch_or_tag }} --depth 1 ~/immortalwrt
          
          # éªŒè¯å…‹éš†æ˜¯å¦æˆåŠŸ
          if [ -d ~/immortalwrt ]; then
            echo "âœ… ImmortalWrt æºç å…‹éš†æˆåŠŸ"
            echo "ç›®å½•å¤§å°: $(du -sh ~/immortalwrt)"
          else
            echo "âŒ ImmortalWrt æºç å…‹éš†å¤±è´¥"
            exit 1
          fi

      - name: Setup feeds and clone custom package
        run: |
          cd ~/immortalwrt
          
          # æ›´æ–°é»˜è®¤ feeds
          echo "æ›´æ–° feeds..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # å…‹éš†æ’ä»¶ä»“åº“åˆ°ä¸´æ—¶ç›®å½•
          echo "å…‹éš†æ’ä»¶ä»“åº“..."
          git clone ${{ inputs.package_repo }} temp_ddns
          
          # æ£€æŸ¥ä»“åº“ç»“æ„
          echo "ä»“åº“ç»“æ„:"
          ls -la temp_ddns/
          
          # æ ¹æ®å®é™…ç»“æ„å¤åˆ¶æ–‡ä»¶
          if [ -d "temp_ddns/ddns-go" ] && [ -d "temp_ddns/luci-app-ddns-go" ]; then
            echo "å‘ç°ä¸¤ä¸ªå­åŒ…ï¼Œåˆ†åˆ«å¤åˆ¶..."
            cp -r temp_ddns/ddns-go package/
            cp -r temp_ddns/luci-app-ddns-go package/
          elif [ -f "temp_ddns/Makefile" ]; then
            echo "å‘ç°æ ¹ç›®å½•åŒ…ï¼Œç›´æ¥å¤åˆ¶..."
            cp -r temp_ddns package/${{ inputs.package_name }}
          else
            echo "æœªè¯†åˆ«çš„ä»“åº“ç»“æ„"
            tree temp_ddns/ || ls -laR temp_ddns/
            exit 1
          fi
          
          # æ¸…ç†ä¸´æ—¶ç›®å½•
          rm -rf temp_ddns
          
          echo "æœ€ç»ˆ package ç›®å½•ç»“æ„:"
          find package/ -name "*ddns*" -type d

      - name: Configure build target
        run: |
          cd ~/immortalwrt
          
          # é…ç½®ç›®æ ‡è®¾å¤‡
          echo "CONFIG_TARGET_rockchip=y" > .config
          echo "CONFIG_TARGET_rockchip_armv8=y" >> .config
          echo "CONFIG_TARGET_rockchip_armv8_DEVICE_${{ inputs.profile }}=y" >> .config
          
          # æ·»åŠ åŒ…åˆ°ç¼–è¯‘é…ç½®
          echo "CONFIG_PACKAGE_ddns-go=m" >> .config
          echo "CONFIG_PACKAGE_${{ inputs.package_name }}=m" >> .config
          
          make defconfig

      - name: Debug package location
        run: |
          cd ~/immortalwrt
          
          echo "=== æ£€æŸ¥åŒ…ç›®å½•ç»“æ„ ==="
          ls -la package/ | grep ddns
          
          echo "=== æ£€æŸ¥ ddns-go åŒ… ==="
          if [ -d "package/ddns-go" ]; then
            echo "ddns-go åŒ…å­˜åœ¨"
            ls -la package/ddns-go/
            [ -f "package/ddns-go/Makefile" ] && echo "ddns-go Makefile å­˜åœ¨"
          fi
          
          echo "=== æ£€æŸ¥ luci-app-ddns-go åŒ… ==="
          if [ -d "package/luci-app-ddns-go" ]; then
            echo "luci-app-ddns-go åŒ…å­˜åœ¨"
            ls -la package/luci-app-ddns-go/
            [ -f "package/luci-app-ddns-go/Makefile" ] && echo "luci-app-ddns-go Makefile å­˜åœ¨"
          fi

      - name: Download dependencies
        run: |
          cd ~/immortalwrt
          make download -j$(nproc)

      - name: Compile the packages
        run: |
          cd ~/immortalwrt
          
          echo "å¼€å§‹ç¼–è¯‘..."
          
          # ç¼–è¯‘ ddns-go åŒ…
          if [ -d "package/ddns-go" ] && [ -f "package/ddns-go/Makefile" ]; then
            echo "ç¼–è¯‘ ddns-go åŒ…..."
            make package/ddns-go/compile -j$(nproc) V=s
          else
            echo "âš ï¸  ddns-go åŒ…ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi
          
          # ç¼–è¯‘ luci-app-ddns-go åŒ…
          if [ -d "package/luci-app-ddns-go" ] && [ -f "package/luci-app-ddns-go/Makefile" ]; then
            echo "ç¼–è¯‘ luci-app-ddns-go åŒ…..."
            make package/luci-app-ddns-go/compile -j$(nproc) V=s
          else
            echo "âš ï¸  luci-app-ddns-go åŒ…ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•åŒ…è¢«æˆåŠŸç¼–è¯‘
          if [ ! -d "package/ddns-go" ] && [ ! -d "package/luci-app-ddns-go" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å¯ç¼–è¯‘çš„åŒ…"
            exit 1
          fi

      - name: Check compiled packages
        run: |
          cd ~/immortalwrt
          
          echo "=== æŸ¥æ‰¾ç¼–è¯‘ç”Ÿæˆçš„ IPK æ–‡ä»¶ ==="
          find bin/ -name "*.ipk" -type f | grep -i ddns || echo "æœªæ‰¾åˆ° ddns ç›¸å…³çš„ IPK æ–‡ä»¶"
          
          echo "=== æ‰€æœ‰ç¼–è¯‘ç”Ÿæˆçš„ IPK æ–‡ä»¶ ==="
          find bin/ -name "*.ipk" -type f || echo "æœªæ‰¾åˆ°ä»»ä½• IPK æ–‡ä»¶"
          
          echo "=== IPK æ–‡ä»¶è¯¦ç»†ä¿¡æ¯ ==="
          find bin/ -name "*.ipk" -type f -exec ls -la {} \; || true

      - name: Organize and upload IPK package
        if: always()  # å³ä½¿å‰é¢æ­¥éª¤å¤±è´¥ä¹Ÿè¦å°è¯•ä¸Šä¼ å·²æœ‰çš„æ–‡ä»¶
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "ipk-${{ inputs.package_name }}-${{ inputs.profile }}-${{ github.run_number }}"
          name: "ImmortalWrt - ${{ inputs.package_name }} (${{ inputs.profile }})"
          body: |
            **è‡ªåŠ¨ç¼–è¯‘ç”Ÿæˆçš„ IPK æ’ä»¶åŒ…**
            
            ğŸ“¦ **ç¼–è¯‘ä¿¡æ¯:**
            - ImmortalWrt ç‰ˆæœ¬: `${{ inputs.immortalwrt_branch_or_tag }}`
            - ç›®æ ‡è®¾å¤‡: `${{ inputs.profile }}`
            - æ’ä»¶ä»“åº“: `${{ inputs.package_repo }}`
            - ç¼–è¯‘æ—¶é—´: ${{ github.event.head_commit.timestamp }}
            - å·¥ä½œæµè¿è¡Œ: #${{ github.run_number }}
            
            ğŸ“‹ **å®‰è£…è¯´æ˜:**
            1. å°† IPK æ–‡ä»¶ä¸Šä¼ åˆ°è·¯ç”±å™¨
            2. ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…: `opkg install *.ipk`
            3. é‡å¯ luci æœåŠ¡: `/etc/init.d/uhttpd restart`
            
            âš ï¸  **æ³¨æ„äº‹é¡¹:**
            - è¯·ç¡®ä¿è·¯ç”±å™¨æ¶æ„ä¸ç¼–è¯‘ç›®æ ‡ä¸€è‡´
            - å®‰è£…å‰å»ºè®®å¤‡ä»½ç³»ç»Ÿé…ç½®
            - å¦‚æœæŸäº›åŒ…ç¼–è¯‘å¤±è´¥ï¼ŒåªåŒ…å«æˆåŠŸç¼–è¯‘çš„åŒ…
          files: |
            ~/immortalwrt/bin/packages/*/*/*.ipk
            ~/immortalwrt/bin/packages/*/*.ipk
            ~/immortalwrt/bin/*.ipk
          prerelease: true
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
