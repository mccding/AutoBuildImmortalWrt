# å·¥ä½œæµåç§°
name: Build-ImmortalWrt-IPK-by-Profile

on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      profile:
        type: choice
        description: 'è¯·é€‰æ‹©æ‚¨çš„è®¾å¤‡å‹å·'
        options:
          - ariaboard_photonicat
          - armsom_sige3
          - armsom_sige7
          - cyber_cyber3588-aib
          - ezpro_mrkaio-m68s
          - firefly_roc-rk3328-cc
          - firefly_roc-rk3568-pc
          - friendlyarm_nanopc-t4
          - friendlyarm_nanopc-t6
          - friendlyarm_nanopi-r2c
          - friendlyarm_nanopi-r2c-plus
          - friendlyarm_nanopi-r2s
          - friendlyarm_nanopi-r3s
          - friendlyarm_nanopi-r4s
          - friendlyarm_nanopi-r4se
          - friendlyarm_nanopi-r4s-enterprise
          - friendlyarm_nanopi-r5c
          - friendlyarm_nanopi-r5s
          - friendlyarm_nanopi-r6c
          - friendlyarm_nanopi-r6s
          - huake_guangmiao-g4c
          - lunzn_fastrhino-r66s
          - lunzn_fastrhino-r68s
          - lyt_t68m
          - pine64_rock64
          - pine64_rockpro64
          - radxa_cm3_io
          - radxa_e25
          - radxa_rock-3a
          - radxa_rock-3b
          - radxa_rock-3c
          - radxa_rock-5a
          - radxa_rock-5b
          - radxa_rock-pi-4a
          - radxa_rock-pi-e
          - radxa_rock-pi-s
          - radxa_zero-3e
          - radxa_zero-3w
          - sinovoip_bpi-r2-pro
          - xunlong_orangepi-5
          - xunlong_orangepi-5-plus
          - xunlong_orangepi-r1-plus
          - xunlong_orangepi-r1-plus-lts
        required: true
        default: 'friendlyarm_nanopi-r3s'
      package_repo:
        description: 'è¦ç¼–è¯‘çš„æ’ä»¶ Git ä»“åº“åœ°å€'
        required: true
        default: 'https://github.com/mccding/luci-app-ddns-go'
      package_name:
        description: 'æ’ä»¶åŒ…å (é€šå¸¸æ˜¯ä»“åº“å)'
        required: true
        default: 'luci-app-ddns-go'
      immortalwrt_version:
        description: 'ImmortalWrt SDK ç‰ˆæœ¬'
        required: true
        default: '24.10.2'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine Target Architecture
        id: Fw_info
        run: |
          echo "TARGET=rockchip" >> $GITHUB_ENV
          echo "SUBTARGET=armv8" >> $GITHUB_ENV
          echo "âœ… è®¾å¤‡å‹å· '${{ inputs.profile }}' å·²æ˜ å°„åˆ°å¹³å°: rockchip/armv8"

      - name: Setup ImmortalWrt SDK environment
        run: |
          SDK_URL="https://downloads.immortalwrt.org/releases/${{ inputs.immortalwrt_version }}/sdk/immortalwrt-sdk-${{ inputs.immortalwrt_version }}-${{ env.TARGET }}-${{ env.SUBTARGET }}_*.tar.xz"
          echo "ğŸ“¥ ä¸‹è½½ SDK from: $SDK_URL"
          wget -q $SDK_URL -O immortalwrt-sdk.tar.xz
          
          tar -xJvf immortalwrt-sdk.tar.xz
          
          SDK_DIR=$(find . -mindepth 1 -maxdepth 1 -type d -name "immortalwrt-sdk-*")
          echo "SDK_DIR=$SDK_DIR" >> $GITHUB_ENV
          cd $SDK_DIR
          echo "âœ… SDK ç¯å¢ƒå‡†å¤‡å°±ç»ª: $(pwd)"

      - name: Clone and compile the package
        run: |
          cd ${{ env.SDK_DIR }}
          git clone --depth 1 ${{ inputs.package_repo }} package/${{ inputs.package_name }}
          echo "âœ… å·²å…‹éš†æ’ä»¶ '${{ inputs.package_name }}'"
          
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘..."
          make package/${{ inputs.package_name }}/compile V=s

      # ##################################################################
      # ## â†“â†“â†“ è¿™é‡Œæ˜¯æœ¬æ¬¡ä¿®æ”¹çš„æ ¸å¿ƒéƒ¨åˆ† â†“â†“â†“
      # ##################################################################
      - name: Organize and upload IPK package
        uses: softprops/action-gh-release@v2
        with:
          # ä¿®æ”¹1: tag_name ä½¿ç”¨æ’ä»¶å, ç¡®ä¿æ¯ä¸ªæ’ä»¶éƒ½æœ‰ç‹¬ç«‹çš„ Release
          tag_name: ipk-${{ inputs.package_name }}
          # ä¿®æ”¹2: Release çš„æ ‡é¢˜ç°åœ¨æ˜¯ "ImmortalWrt - <ä½ çš„æ’ä»¶å>"
          name: ImmortalWrt - ${{ inputs.package_name }}
          body: |
            è‡ªåŠ¨ç¼–è¯‘ç”Ÿæˆçš„ IPK æ’ä»¶åŒ…ã€‚
            - ç›®æ ‡è®¾å¤‡: `${{ inputs.profile }}`
            - ç›®æ ‡å¹³å°: `${{ env.TARGET }}/${{ env.SUBTARGET }}`
            - æ’ä»¶ä»“åº“: `${{ inputs.package_repo }}`
          files: |
            ${{ env.SDK_DIR }}/bin/packages/*/*/*.ipk
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
